@model List<Mekaniko_Secured.Models.Dto.CarInvoiceSummaryDto>

<h2>Customer Details</h2>

<div class="customer-car-details d-flex justify-content-between align-items-center container mt-3">
    <div class="left">
        <p>Customer ID: <span class="fw-bold">@Model[0].CustomerId</span></p>
        <p>Customer Name: <span class="fw-bold">@Model[0].CustomerName</span></p>
        <p>Email Address: <span class="fw-bold">@Model[0].CustomerEmail</span></p>
        <p>Contact #: <span class="fw-bold">@Model[0].CustomerNumber</span></p>
    </div>
    <div class="right">
        <p>Car ID: <span class="fw-bold">@Model[0].CarId</span></p>
        <p>Car Rego: <span class="fw-bold">@Model[0].CarRego</span></p>
        <p>Car Make: <span class="fw-bold">@Model[0].MakeName</span></p>
        <p>Car Model: <span class="fw-bold">@Model[0].CarModel</span></p>
        <p>Car Year: <span class="fw-bold">@Model[0].CarYear</span></p>
       
    </div>
</div>

<div class="container d-flex justify-content-between align-items-center mt-5">
    <div class="left">
        <h2>Transactions</h2>
    </div>
    <div class="right">
        <a class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#addInvoiceModal"><i class="bi bi-plus-square-fill"></i> Invoice</a>
    </div>
</div>
<input type="hidden" id="ViewInvoiceId" />
<table class="table table-striped">
    <thead>
        <tr>
            <th class="text-center">Invoice ID</th>
            <th class="text-center">Issue</th>
            <th class="text-center">Date Issued</th>
            <th class="text-center">Due Date</th>
            <th class="text-center">Total Amount</th>
            <th class="text-center">Amount Paid</th>
            <th class="text-center">Status</th>
            <th class="text-center">Action</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var invoice in Model)
        {
            <tr>
                <td class="text-center">@invoice.InvoiceId</td>
                <td class="text-center">@invoice.IssueName</td>
                <td class="text-center">@invoice.DateAdded?.ToString("MM/dd/yyyy")</td>
                <td class="text-center">@invoice.DueDate?.ToString("MM/dd/yyyy")</td>
                <td class="text-center">@invoice.TotalAmount</td>
                <td class="text-center">@invoice.AmountPaid</td>
                <td class="payment-status-column text-center">
                    @if (invoice.IsPaid == true)
                    {
                        <p class="payment-status-paid">Paid</p>
                    }
                    else
                    {
                        <p class="payment-status-not-paid">Not Paid</p>
                    }
                </td>
                <td class="text-center">
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="actionDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <span class="visually-hidden">Toggle Dropdown</span>
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="actionDropdown">
                               @*  <li>
                                    <a href="#" class="dropdown-item view-invoice" data-invoice-id="@invoice.InvoiceId">
                                        <i class="bi bi-eye"></i> Open Invoice
                                    </a>
                                </li> *@
                                <li>
                                    <button class="dropdown-item mark-as-paid" data-invoice-id="@invoice.InvoiceId">
                                        <i class="bi bi-check-lg"></i> Mark as Paid
                                    </button>
                                </li>
                                <li>
                                    <button class="dropdown-item view-pdf" data-invoice-id="@invoice.InvoiceId"><i class="bi bi-file-pdf"></i> View PDF</button>
                                </li>
                                <li>
                                    <a href="#" class="dropdown-item download-pdf" data-invoice-id="@invoice.InvoiceId">
                                        <i class="bi bi-download"></i> Download PDF
                                    </a>
                                </li>
                                <li>
                                    <a href="#" class="dropdown-item send-invoice-email" data-invoice-id="@invoice.InvoiceId">
                                        <i class="bi bi-envelope-paper"></i> Send Email
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item btn-danger"><i class="bi bi-trash3-fill"></i> Delete Invoice</a>
                                </li>
                            </ul>
                        </div>
                </td> 
            </tr>
        }
    </tbody>
</table>

<!-- Store the CSRF token and URLs as data attributes on a global element -->
<div id="scriptData"
     data-add-invoice-url="@Url.Action("AddInvoiceToCar", "Invoice")"
     data-mark-as-paid-url="@Url.Action("MarkAsPaid", "Invoice")"
     data-view-pdf-url="@Url.Action("GeneratePdf", "Invoice")"
     data-send-invoice-email-url="@Url.Action("SendInvoiceEmail", "Invoice")">
</div>

@*Render the partial view for modals*@
@Html.Partial("_CarInvoiceModals")

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/jquery.validation/1.19.3/jquery.validate.min.js"></script>

    <script>
        // Provide the CSRF token and URLs to your external script
        var csrfToken = $('input[name="__RequestVerificationToken"]').val();
        var addInvoiceUrl = '@Url.Action("AddInvoiceToCar", "Invoice")';
        var getInvoiceDetailsUrl = '@Url.Action("GetInvoiceDetails", "Invoice")';


        var markAsPaidUrl = $('#scriptData').data('mark-as-paid-url');
    </script>

    <script src="~/js/carInvoice.js"></script>  <!-- External JS file -->

   @*  <script>
        // Ensure these values are defined before you use them
        var csrfToken = $('input[name="__RequestVerificationToken"]').val();
        var markAsPaidUrl = '@Url.Action("MarkAsPaid", "Invoice")';

        // Mark as Paid functionality directly in the cshtml file
                $(document).off('click', '.mark-as-paid').on('click', '.mark-as-paid', function (e) {
            e.preventDefault();
            console.log("Mark as paid clicked");

            var invoiceId = $(this).data('invoice-id');
            console.log("Invoice ID:", invoiceId);

            if (confirm("Are you sure you want to mark this invoice as paid?")) {
                markInvoiceAsPaid(invoiceId);
            }
        });

        function markInvoiceAsPaid(invoiceId) {
            console.log("Sending AJAX request to mark invoice as paid");

            $.ajax({
                url: markAsPaidUrl,
                type: 'POST',
                data: { invoiceId: invoiceId },
                headers: {
                    'RequestVerificationToken': csrfToken
                },
                success: function (response) {
                    console.log("AJAX response received:", response);
                    if (response.success) {
                        alert(response.message);
                        location.reload();
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('AJAX error:', status, error);
                    console.error('Response text:', xhr.responseText);
                    alert('An error occurred while marking the invoice as paid.');
                }
            });
        }
    </script> *@
}